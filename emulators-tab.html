<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Emulators — Infrastructure Panel</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
<style>
  :root {
    --bg:           #0d0f12;
    --surface:      #13161b;
    --surface-2:    #1a1e26;
    --surface-3:    #20263200;
    --border:       #252a35;
    --text:         #e2e8f0;
    --muted:        #5a6580;
    --muted-2:      #3d4558;
    --primary:      #4f9eff;
    --emerald:      #22c55e;
    --emerald-dim:  rgba(34,197,94,.12);
    --emerald-bdr:  rgba(34,197,94,.22);
    --amber:        #f59e0b;
    --red:          #ef4444;
    --red-dim:      rgba(239,68,68,.12);
    --indigo:       #6366f1;
    --indigo-dim:   rgba(99,102,241,.12);
    --font:         'IBM Plex Sans', sans-serif;
    --font-mono:    'JetBrains Mono', monospace;
    --r:            8px;
    --r-sm:         5px;
    --shadow:       0 8px 32px rgba(0,0,0,.55);
  }
  *, *::before, *::after { box-sizing:border-box; margin:0; padding:0; }
  body {
    font-family: var(--font);
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    font-size: 14px;
    line-height: 1.5;
    padding: 24px;
    background-image:
      linear-gradient(rgba(255,255,255,.013) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255,255,255,.013) 1px, transparent 1px);
    background-size: 40px 40px;
  }

  /* ─ PAGE HEADER ─────────────────────────────── */
  .page-header { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:24px; }
  .page-header h2 {
    font-family: var(--font-mono); font-size:20px; font-weight:700;
    letter-spacing:-.02em; display:flex; align-items:center; gap:10px;
  }
  .badge-infra {
    font-size:9px; font-weight:600; letter-spacing:.1em; text-transform:uppercase;
    padding:2px 7px; background:var(--indigo-dim); color:#a5b4fc;
    border:1px solid rgba(99,102,241,.25); border-radius:99px;
  }
  .page-header p { font-size:13px; color:var(--muted); margin-top:3px; }

  /* ─ STATS ────────────────────────────────────── */
  .stats-row { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:20px; }
  .stat-card {
    background:var(--surface); border:1px solid var(--border); border-radius:var(--r);
    padding:16px; position:relative; overflow:hidden;
  }
  .stat-card::before {
    content:''; position:absolute; inset:0;
    background:linear-gradient(135deg,rgba(255,255,255,.025) 0%,transparent 60%);
    pointer-events:none;
  }
  .stat-label {
    font-size:11px; font-weight:600; letter-spacing:.07em; text-transform:uppercase;
    color:var(--muted); font-family:var(--font-mono); margin-bottom:10px;
    display:flex; align-items:center; justify-content:space-between;
  }
  .stat-value { font-family:var(--font-mono); font-size:28px; font-weight:700; letter-spacing:-.03em; line-height:1; }
  .stat-card.total .stat-value   { color:#c4b5fd; }
  .stat-card.running .stat-value { color:var(--emerald); }
  .stat-card.stopped .stat-value { color:var(--amber); }
  .stat-icon { width:28px; height:28px; display:flex; align-items:center; justify-content:center; border-radius:6px; }
  .stat-card.total .stat-icon   { background:var(--indigo-dim); color:#a5b4fc; }
  .stat-card.running .stat-icon { background:var(--emerald-dim); color:var(--emerald); }
  .stat-card.stopped .stat-icon { background:rgba(245,158,11,.12); color:var(--amber); }
  .qa-card {
    background:var(--surface); border:1px solid var(--border); border-radius:var(--r);
    padding:16px; display:flex; flex-direction:column; gap:12px;
  }
  .qa-btns { display:flex; gap:8px; }

  /* ─ TOOLBAR ──────────────────────────────────── */
  .toolbar {
    display:flex; align-items:center; justify-content:space-between;
    gap:12px; margin-bottom:0; flex-wrap:wrap;
  }
  .toolbar-left  { display:flex; align-items:center; gap:10px; flex:1; min-width:0; }
  .toolbar-right { display:flex; align-items:center; gap:10px; flex-shrink:0; }

  .search-wrap { position:relative; max-width:260px; width:100%; }
  .search-wrap svg { position:absolute; left:10px; top:50%; transform:translateY(-50%); width:14px; height:14px; color:var(--muted); pointer-events:none; }
  .search-input {
    width:100%; height:34px; padding:0 10px 0 32px;
    background:var(--surface-2); border:1px solid var(--border); border-radius:var(--r-sm);
    color:var(--text); font-family:var(--font); font-size:13px; outline:none;
    transition:border-color .15s, box-shadow .15s;
  }
  .search-input::placeholder { color:var(--muted); }
  .search-input:focus { border-color:var(--primary); box-shadow:0 0 0 3px rgba(79,158,255,.12); }

  .filter-pills { display:flex; background:var(--surface); border:1px solid var(--border); border-radius:var(--r-sm); padding:3px; gap:2px; }
  .pill { padding:5px 12px; font-size:12px; font-weight:600; font-family:var(--font-mono); border-radius:4px; border:none; background:transparent; color:var(--muted); cursor:pointer; transition:background .15s,color .15s; letter-spacing:.03em; }
  .pill.active { background:var(--surface-2); color:var(--text); box-shadow:0 1px 3px rgba(0,0,0,.4); }
  .pill:hover:not(.active) { color:var(--text); }

  .v-div { width:1px; height:22px; background:var(--border); flex-shrink:0; }

  /* ─ BUTTONS ──────────────────────────────────── */
  .btn {
    display:inline-flex; align-items:center; gap:6px; height:32px; padding:0 12px;
    font-family:var(--font); font-size:12px; font-weight:600;
    border-radius:var(--r-sm); border:1px solid var(--border);
    cursor:pointer; transition:all .15s; white-space:nowrap; letter-spacing:.01em;
  }
  .btn-ghost   { background:transparent; color:var(--muted); }
  .btn-ghost:hover { background:var(--surface-2); color:var(--text); }
  .btn-outline { background:var(--surface); color:var(--text); }
  .btn-outline:hover { background:var(--surface-2); border-color:var(--muted-2); }
  .btn-primary { background:rgba(79,158,255,.14); color:var(--primary); border-color:rgba(79,158,255,.3); }
  .btn-primary:hover { background:rgba(79,158,255,.22); }
  .btn-emerald { background:var(--emerald-dim); color:var(--emerald); border-color:var(--emerald-bdr); }
  .btn-emerald:hover { background:rgba(34,197,94,.2); }
  .btn-danger  { background:var(--red-dim); color:var(--red); border-color:rgba(239,68,68,.25); }
  .btn-danger:hover { background:rgba(239,68,68,.2); }
  .btn-sm  { height:28px; padding:0 10px; font-size:11px; }
  .btn-icon{ width:28px; height:28px; padding:0; justify-content:center; }
  .btn:disabled { opacity:.38; cursor:not-allowed; pointer-events:none; }

  /* Toggle */
  .toggle-wrap { display:flex; align-items:center; gap:8px; }
  .toggle-label { font-size:12px; font-weight:600; color:var(--muted); font-family:var(--font-mono); letter-spacing:.04em; }
  .toggle { position:relative; width:36px; height:20px; background:var(--surface-2); border:1px solid var(--border); border-radius:10px; cursor:pointer; transition:background .2s,border-color .2s; }
  .toggle.on { background:rgba(34,197,94,.25); border-color:var(--emerald-bdr); }
  .toggle-thumb { position:absolute; top:2px; left:2px; width:14px; height:14px; background:var(--muted); border-radius:50%; transition:transform .2s,background .2s; }
  .toggle.on .toggle-thumb { transform:translateX(16px); background:var(--emerald); }

  /* ════════════════════════════════════════════
     CHROME-STYLE TABS
  ════════════════════════════════════════════ */
  .chrome-tabbar-wrap {
    position: relative;
    margin-top: 14px;
    margin-bottom: 0;
  }

  /* The background track — looks like the bottom edge of Chrome's tab strip */
  .chrome-tabbar {
    display: flex;
    align-items: flex-end;
    gap: 0;
    padding: 0 0 0 0;
    position: relative;
    /* bottom border = the "page content" edge */
    border-bottom: 1.5px solid var(--border);
    overflow-x: auto;
    scrollbar-width: none;
  }
  .chrome-tabbar::-webkit-scrollbar { display:none; }

  /* Individual tab */
  .chrome-tab {
    position: relative;
    display: flex;
    align-items: center;
    gap: 7px;
    height: 34px;
    padding: 0 10px 0 13px;
    min-width: 100px;
    max-width: 200px;
    background: var(--surface-2);
    border: 1.5px solid var(--border);
    border-bottom: none;
    border-radius: 8px 8px 0 0;
    cursor: pointer;
    user-select: none;
    font-size: 12px;
    font-weight: 600;
    color: var(--muted);
    transition: background .15s, color .15s;
    flex-shrink: 0;
    /* Chrome tab overlap */
    margin-right: -1px;
    z-index: 1;
  }
  .chrome-tab:hover:not(.active-tab) {
    background: #1e2330;
    color: #8899bb;
  }
  /* Active tab sits above the border */
  .chrome-tab.active-tab {
    background: var(--surface);
    color: var(--text);
    border-color: var(--border);
    border-bottom-color: var(--surface); /* "merges" with content area */
    z-index: 3;
    margin-bottom: -1.5px; /* overlap the bottom border */
    height: 36px;
  }

  /* The left/right curved "notches" mimicking Chrome's shape */
  .chrome-tab::before,
  .chrome-tab::after {
    content: '';
    position: absolute;
    bottom: 0;
    width: 8px;
    height: 8px;
    pointer-events: none;
  }
  /* left notch */
  .chrome-tab::before {
    left: -8px;
    border-bottom-right-radius: 8px;
    box-shadow: 3px 0 0 0 var(--surface-2);
    background: transparent;
  }
  .chrome-tab.active-tab::before {
    box-shadow: 3px 0 0 0 var(--surface);
  }
  /* right notch */
  .chrome-tab::after {
    right: -8px;
    border-bottom-left-radius: 8px;
    box-shadow: -3px 0 0 0 var(--surface-2);
    background: transparent;
  }
  .chrome-tab.active-tab::after {
    box-shadow: -3px 0 0 0 var(--surface);
  }

  .tab-favicon {
    width: 12px; height: 12px;
    border-radius: 50%;
    flex-shrink: 0;
    background: var(--muted-2);
    transition: background .15s;
  }
  .chrome-tab.active-tab .tab-favicon { background: var(--primary); }
  .tab-count-pill {
    font-family: var(--font-mono);
    font-size: 10px; font-weight: 700;
    padding: 1px 5px;
    border-radius: 99px;
    background: rgba(255,255,255,.07);
    color: var(--muted);
    flex-shrink: 0;
    min-width: 18px;
    text-align: center;
  }
  .chrome-tab.active-tab .tab-count-pill {
    background: rgba(79,158,255,.18);
    color: var(--primary);
  }
  .tab-label { flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .tab-close {
    width: 16px; height: 16px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    background: none; border: none; cursor: pointer;
    color: var(--muted); flex-shrink: 0; padding:0;
    transition: background .15s, color .15s;
    opacity: 0;
  }
  .chrome-tab:hover .tab-close,
  .chrome-tab.active-tab .tab-close { opacity: 1; }
  .tab-close:hover { background: rgba(255,255,255,.12); color: var(--text); }

  /* "All" tab (can't be closed) */
  .chrome-tab.tab-all .tab-close { display:none; }

  /* New tab button */
  .new-tab-btn {
    display: flex; align-items: center; justify-content: center;
    width: 28px; height: 28px; margin: 0 4px 4px;
    background: none; border: none; cursor: pointer;
    border-radius: 50%; color: var(--muted);
    transition: background .15s, color .15s;
    flex-shrink: 0;
  }
  .new-tab-btn:hover { background: var(--surface-2); color: var(--text); }

  /* Tab rename inline */
  .tab-label-input {
    width: 80px; font-size:12px; font-weight:600;
    background: transparent; border: none; outline: none;
    color: var(--text); font-family: var(--font); padding:0;
  }

  /* ─ SELECT ROW ───────────────────────────────── */
  .select-row {
    display:flex; align-items:center; gap:10px;
    padding: 10px 14px 8px;
  }
  .select-row label { font-size:12px; font-weight:600; color:var(--muted); cursor:pointer; font-family:var(--font-mono); letter-spacing:.04em; }
  .sel-hint { font-size:12px; color:var(--muted); }
  .sel-hint strong { color:var(--primary); }

  /* ─ INSTANCE LIST ────────────────────────────── */
  /* content area matches the active tab */
  .tab-content-area {
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-top: none;
    border-radius: 0 0 var(--r) var(--r);
    padding: 0 0 8px;
  }

  #emu-list { display:flex; flex-direction:column; gap:6px; padding: 0 12px 4px; }

  .emu-card {
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-left: 3px solid transparent;
    border-radius: var(--r);
    padding: 11px 12px;
    display: flex; align-items: center; gap: 12px;
    position: relative; cursor: default;
    transition: background .15s, border-color .15s;
    animation: slideIn .22s ease both;
  }
  .emu-card.running-card {
    border-left-color: var(--emerald);
    background: linear-gradient(to right, rgba(34,197,94,.05), var(--surface-2) 38%);
  }
  .emu-card:hover { background: #1d2230; }
  .emu-card.selected { background:rgba(79,158,255,.06); border-color:rgba(79,158,255,.2); }

  @keyframes slideIn {
    from { opacity:0; transform:translateY(5px); }
    to   { opacity:1; transform:translateY(0); }
  }

  .idx-badge {
    width:34px; height:34px; display:flex; align-items:center; justify-content:center;
    background:var(--surface); border:1px solid var(--border); border-radius:var(--r-sm);
    font-family:var(--font-mono); font-size:11px; font-weight:700; color:var(--muted); flex-shrink:0;
  }
  .running-card .idx-badge { background:var(--emerald-dim); border-color:var(--emerald-bdr); color:var(--emerald); }

  .emu-info { display:flex; flex-direction:column; gap:4px; min-width:0; flex:1; }
  .emu-name { font-size:13px; font-weight:600; color:var(--text); display:flex; align-items:center; gap:8px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .emu-meta { display:flex; align-items:center; gap:6px; flex-wrap:wrap; font-family:var(--font-mono); font-size:10.5px; color:var(--muted); }
  .sep { opacity:.22; }
  .serial-text { color:rgba(79,158,255,.8); }
  .copy-btn { background:none; border:none; cursor:pointer; padding:0 2px; color:var(--muted-2); display:inline-flex; align-items:center; line-height:1; transition:color .15s; }
  .copy-btn:hover { color:var(--primary); }

  .status-badge {
    font-family:var(--font-mono); font-size:9.5px; font-weight:700;
    letter-spacing:.08em; text-transform:uppercase;
    padding:3px 8px; border-radius:99px; flex-shrink:0;
  }
  .badge-running { background:var(--emerald-dim); color:var(--emerald); border:1px solid var(--emerald-bdr); }
  .badge-stopped { background:rgba(90,101,128,.15); color:var(--muted); border:1px solid var(--border); }

  .pulse-dot { width:6px; height:6px; border-radius:50%; background:var(--emerald); display:inline-block; margin-right:5px; animation:pulse 2s ease-in-out infinite; }
  @keyframes pulse {
    0%,100% { opacity:1; transform:scale(1); box-shadow:0 0 0 0 rgba(34,197,94,.5); }
    50%      { opacity:.8; transform:scale(1.15); box-shadow:0 0 0 4px rgba(34,197,94,0); }
  }

  .card-actions { display:flex; align-items:center; gap:8px; margin-left:auto; flex-shrink:0; }
  .hover-actions { display:flex; gap:5px; opacity:0; transition:opacity .15s; }
  .emu-card:hover .hover-actions { opacity:1; }

  input[type=checkbox] { width:15px; height:15px; cursor:pointer; accent-color:var(--primary); flex-shrink:0; }

  .rename-input {
    font-size:13px; font-weight:600; height:28px; padding:0 8px;
    background:var(--bg); border:1px solid var(--primary); border-radius:4px;
    color:var(--text); font-family:var(--font); outline:none; width:180px;
    box-shadow:0 0 0 3px rgba(79,158,255,.12);
  }

  /* ─ DROPDOWN MENU (···) ──────────────────────── */
  .dropdown-menu {
    position:fixed; z-index:9999;
    background:var(--surface-2); border:1px solid var(--border);
    border-radius:var(--r); box-shadow:var(--shadow);
    padding:4px; min-width:180px;
    animation:fadeUp .1s ease;
  }
  @keyframes fadeUp { from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:translateY(0)} }
  .dd-item {
    display:flex; align-items:center; gap:9px;
    padding:7px 10px; border-radius:5px; font-size:12px; font-weight:500;
    cursor:pointer; border:none; background:none; width:100%; text-align:left;
    color:var(--text); transition:background .1s; font-family:var(--font);
  }
  .dd-item:hover { background:var(--surface); }
  .dd-item.danger { color:var(--red); }
  .dd-item.disabled { color:var(--muted-2); cursor:default; pointer-events:none; }
  .dd-sep { height:1px; background:var(--border); margin:4px 0; }
  .dd-icon { width:14px; text-align:center; font-size:11px; flex-shrink:0; opacity:.8; }
  .dd-sub-label { font-size:10px; font-weight:600; letter-spacing:.06em; text-transform:uppercase; color:var(--muted); padding:6px 10px 3px; font-family:var(--font-mono); }
  .dd-item.tab-option {
    padding-left: 14px;
    font-size: 11.5px;
  }
  .dd-item.tab-option .tab-dot {
    width:8px; height:8px; border-radius:50%; flex-shrink:0;
  }

  /* ─ EMPTY ─────────────────────────────────────── */
  .empty-state {
    background:transparent; border:1px dashed rgba(255,255,255,.07);
    border-radius:var(--r); padding:40px;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    gap:10px; color:var(--muted); margin:8px 12px;
  }

  /* ─ TOAST ─────────────────────────────────────── */
  #toast-container { position:fixed; bottom:24px; right:24px; display:flex; flex-direction:column; gap:8px; z-index:10000; pointer-events:none; }
  .toast { padding:10px 16px; border-radius:var(--r); font-size:12px; font-weight:500; background:var(--surface-2); border:1px solid var(--border); box-shadow:var(--shadow); color:var(--text); display:flex; align-items:center; gap:10px; animation:toastIn .25s ease both; pointer-events:all; max-width:300px; }
  .toast.success { border-color:var(--emerald-bdr); }
  .toast.info    { border-color:rgba(79,158,255,.3); }
  .toast.error   { border-color:rgba(239,68,68,.3); }
  .toast-dot { width:6px; height:6px; border-radius:50%; flex-shrink:0; }
  .toast.success .toast-dot { background:var(--emerald); }
  .toast.info    .toast-dot { background:var(--primary); }
  .toast.error   .toast-dot { background:var(--red); }
  @keyframes toastIn { from{opacity:0;transform:translateX(20px)} to{opacity:1;transform:translateX(0)} }
  .toast-fade { animation:toastOut .3s ease forwards; }
  @keyframes toastOut { to{opacity:0;transform:translateX(20px)} }

  .spinner { width:12px; height:12px; border:2px solid currentColor; border-top-color:transparent; border-radius:50%; animation:spin .6s linear infinite; flex-shrink:0; }
  @keyframes spin { to{transform:rotate(360deg)} }
  #last-refresh { font-family:var(--font-mono); font-size:10px; color:var(--muted); white-space:nowrap; }

  ::-webkit-scrollbar { width:6px; }
  ::-webkit-scrollbar-track { background:transparent; }
  ::-webkit-scrollbar-thumb { background:var(--border); border-radius:99px; }

  /* Tab color accents */
  .tab-color-0 { --tc: #4f9eff; }
  .tab-color-1 { --tc: #22c55e; }
  .tab-color-2 { --tc: #f59e0b; }
  .tab-color-3 { --tc: #a78bfa; }
  .tab-color-4 { --tc: #f472b6; }
  .tab-color-5 { --tc: #34d399; }
  .chrome-tab.active-tab .tab-favicon { background: var(--tc, var(--primary)); }
  .chrome-tab.active-tab .tab-count-pill { background:rgba(var(--tc-rgb,79,158,255),.18); color:var(--tc, var(--primary)); }
</style>
</head>
<body>

<div>
  <!-- Header -->
  <div class="page-header">
    <div>
      <h2>Emulator Instances <span class="badge-infra">Infrastructure</span></h2>
      <p>Infrastructure control panel — start, stop, restart and inspect all LDPlayer instances.</p>
    </div>
  </div>

  <!-- Stats -->
  <div class="stats-row">
    <div class="stat-card total">
      <div class="stat-label">Total Instances
        <span class="stat-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg></span>
      </div>
      <div class="stat-value" id="stat-total">0</div>
    </div>
    <div class="stat-card running">
      <div class="stat-label">Running
        <span class="stat-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg></span>
      </div>
      <div class="stat-value" id="stat-running">0</div>
    </div>
    <div class="stat-card stopped">
      <div class="stat-label">Stopped
        <span class="stat-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="6" width="12" height="12" rx="2"/></svg></span>
      </div>
      <div class="stat-value" id="stat-stopped">0</div>
    </div>
    <div class="qa-card">
      <div class="stat-label">Quick Actions</div>
      <div class="qa-btns">
        <button class="btn btn-emerald btn-sm" style="flex:1;justify-content:center;" onclick="App.startAll()">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="5 3 19 12 5 21 5 3"/></svg>Start All
        </button>
        <button class="btn btn-danger btn-sm" style="flex:1;justify-content:center;" onclick="App.stopAll()">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>Stop All
        </button>
      </div>
    </div>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="toolbar-left">
      <div class="search-wrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input class="search-input" type="text" placeholder="Search name, index, serial…" oninput="App.setSearch(this.value)" />
      </div>
      <div class="filter-pills">
        <button class="pill active" id="pill-all"     onclick="App.setFilter('all')">ALL</button>
        <button class="pill"        id="pill-running"  onclick="App.setFilter('running')">RUNNING</button>
        <button class="pill"        id="pill-stopped"  onclick="App.setFilter('stopped')">STOPPED</button>
      </div>
    </div>
    <div class="toolbar-right">
      <button class="btn btn-primary btn-sm" id="btn-start-sel" onclick="App.startSelected()" disabled>
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
        Start (<span id="sel-count-start">0</span>)
      </button>
      <button class="btn btn-danger btn-sm" id="btn-stop-sel" onclick="App.stopSelected()" disabled>
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
        Stop (<span id="sel-count-stop">0</span>)
      </button>
      <div class="v-div"></div>
      <button class="btn btn-outline btn-sm" onclick="App.manualRefresh()" id="btn-refresh">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
        Refresh
      </button>
      <span id="last-refresh">—</span>
      <div class="v-div"></div>
      <div class="toggle-wrap">
        <span class="toggle-label">AUTO</span>
        <div style="position:relative;">
          <svg id="countdown-ring" width="34" height="34" viewBox="0 0 34 34" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;opacity:.6;">
            <circle cx="17" cy="17" r="14" fill="none" stroke="rgba(255,255,255,.06)" stroke-width="2"/>
            <circle id="countdown-arc" cx="17" cy="17" r="14" fill="none" stroke="#22c55e" stroke-width="2" stroke-dasharray="87.96" stroke-dashoffset="0" stroke-linecap="round" style="transform:rotate(-90deg);transform-origin:center;transition:stroke-dashoffset 1s linear;"/>
          </svg>
          <div class="toggle on" id="auto-toggle" onclick="App.toggleAuto()" style="position:relative;z-index:1;">
            <div class="toggle-thumb"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ══════════════════════════════════════════
       CHROME TABS
  ══════════════════════════════════════════ -->
  <div class="chrome-tabbar-wrap">
    <div class="chrome-tabbar" id="chrome-tabbar">
      <!-- tabs rendered by JS -->
    </div>
  </div>

  <!-- Content area (below tabs) -->
  <div class="tab-content-area">
    <!-- Select all row -->
    <div class="select-row">
      <input type="checkbox" id="cb-select-all" onchange="App.toggleSelectAll(this.checked)" />
      <label for="cb-select-all">SELECT ALL</label>
      <span class="sel-hint" id="sel-hint" style="display:none;">
        — <strong id="sel-label">0</strong> selected
      </span>
    </div>

    <!-- Instance list -->
    <div id="emu-list"></div>
  </div>
</div>

<div id="toast-container"></div>

<script>
// ── MOCK DATA ──────────────────────────────────────
const SEED = [
  { index:0, name:'COD_Farm_01',   running:true,  pid:4821, resolution:'960x540',  dpi:240 },
  { index:1, name:'COD_Farm_02',   running:true,  pid:5012, resolution:'960x540',  dpi:240 },
  { index:2, name:'COD_Farm_03',   running:false, pid:null, resolution:'960x540',  dpi:240 },
  { index:3, name:'COD_Farm_04',   running:true,  pid:6234, resolution:'960x540',  dpi:240 },
  { index:4, name:'COD_Scanner_A', running:false, pid:null, resolution:'1280x720', dpi:320 },
  { index:5, name:'COD_Scanner_B', running:false, pid:null, resolution:'1280x720', dpi:320 },
  { index:6, name:'COD_Main',      running:true,  pid:7891, resolution:'960x540',  dpi:240 },
  { index:7, name:'TEST_Emulator', running:false, pid:null, resolution:'960x540',  dpi:240 },
];

// ── TAB COLORS ─────────────────────────────────────
const TAB_COLORS = ['#4f9eff','#22c55e','#f59e0b','#a78bfa','#f472b6','#34d399'];

// ── APP ────────────────────────────────────────────
const App = {
  instances: JSON.parse(JSON.stringify(SEED)),
  selected: new Set(),
  filter: 'all',
  search: '',
  autoRefresh: true,
  renamingIndex: null,
  activeMenu: null,        // active dropdown/context menu
  pollTimer: null,
  countdownTimer: null,
  countdownElapsed: 0,
  POLL_SEC: 5,

  // ── TABS ──────────────────────────────────────
  // tabs: [{id, label, color, indices: Set}]
  // 'all' tab = id:'all', indices = null (means show all unassigned+all)
  tabs: [
    { id: 'all',    label: 'All Instances', color: '#4f9eff',  indices: null },
    { id: 'tab-1',  label: 'Farming',       color: '#22c55e',  indices: new Set([0,1,2,3]) },
    { id: 'tab-2',  label: 'Scanners',      color: '#f59e0b',  indices: new Set([4,5]) },
  ],
  activeTabId: 'all',
  tabCounter: 3,
  renamingTabId: null,

  init() {
    this.renderAll();
    this.renderTabs();
    this.setupPoll();
    this.startCountdown();
    this.updateLastRefresh();
  },

  // ── POLLING ────────────────────────────────────
  setupPoll() {
    clearInterval(this.pollTimer);
    if (this.autoRefresh) this.pollTimer = setInterval(() => this.silentRefresh(), this.POLL_SEC * 1000);
  },
  startCountdown() {
    clearInterval(this.countdownTimer);
    const circ = 87.96;
    this.countdownElapsed = 0;
    this.countdownTimer = setInterval(() => {
      if (!this.autoRefresh) return;
      this.countdownElapsed = (this.countdownElapsed + 1) % this.POLL_SEC;
      const arc = document.getElementById('countdown-arc');
      if (arc) arc.style.strokeDashoffset = circ * (this.countdownElapsed / this.POLL_SEC);
    }, 1000);
  },
  silentRefresh() { this.updateLastRefresh(); this.renderStats(); this.renderList(); },
  async manualRefresh() {
    const btn = document.getElementById('btn-refresh');
    if (btn) { btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Loading…'; }
    await this.delay(600);
    this.updateLastRefresh();
    this.renderAll();
    if (btn) {
      btn.disabled = false;
      btn.innerHTML = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg> Refresh`;
    }
    Toast.show('success', 'Refreshed', `${this.instances.length} instances loaded.`);
  },
  toggleAuto() {
    this.autoRefresh = !this.autoRefresh;
    const t = document.getElementById('auto-toggle');
    const r = document.getElementById('countdown-ring');
    if (t) t.classList.toggle('on', this.autoRefresh);
    if (r) r.style.opacity = this.autoRefresh ? '.6' : '.15';
    this.setupPoll();
  },
  updateLastRefresh() {
    const el = document.getElementById('last-refresh');
    if (!el) return;
    const now = new Date();
    const p = n => String(n).padStart(2,'0');
    el.textContent = `${p(now.getHours())}:${p(now.getMinutes())}:${p(now.getSeconds())}`;
  },

  // ── TABS ──────────────────────────────────────
  renderTabs() {
    const bar = document.getElementById('chrome-tabbar');
    bar.innerHTML = '';

    this.tabs.forEach((tab, i) => {
      const isActive = tab.id === this.activeTabId;
      const count = tab.indices === null
        ? this.instances.length
        : tab.indices.size;

      const el = document.createElement('div');
      el.className = `chrome-tab tab-color-${i % TAB_COLORS.length} ${isActive ? 'active-tab' : ''} ${tab.id === 'all' ? 'tab-all' : ''}`;
      el.style.setProperty('--tc', tab.color);
      el.dataset.tabId = tab.id;

      // Double-click to rename
      el.ondblclick = (e) => { e.stopPropagation(); this.startTabRename(tab.id); };
      el.onclick = (e) => {
        if (e.target.closest('.tab-close') || e.target.closest('.tab-label-input')) return;
        this.switchTab(tab.id);
      };

      // Label (normal or renaming)
      const labelHtml = (this.renamingTabId === tab.id)
        ? `<input type="text" class="tab-label-input" id="tab-rename-input"
               value="${this.escHtml(tab.label)}"
               onkeydown="App.handleTabRenameKey(event,'${tab.id}')"
               onblur="App.commitTabRename('${tab.id}',this.value)"
               onclick="event.stopPropagation()" />`
        : `<span class="tab-label">${this.escHtml(tab.label)}</span>`;

      el.innerHTML = `
        <div class="tab-favicon" style="background:${tab.color};opacity:${isActive?'1':'.4'};"></div>
        ${labelHtml}
        <span class="tab-count-pill">${count}</span>
        ${tab.id !== 'all' ? `<button class="tab-close" title="Close tab" onclick="App.closeTab('${tab.id}',event)">
          <svg width="8" height="8" viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.8">
            <line x1="1" y1="1" x2="9" y2="9"/><line x1="9" y1="1" x2="1" y2="9"/>
          </svg>
        </button>` : ''}
      `;
      bar.appendChild(el);

      // Focus rename input
      if (this.renamingTabId === tab.id) {
        requestAnimationFrame(() => {
          const inp = document.getElementById('tab-rename-input');
          if (inp) { inp.focus(); inp.select(); }
        });
      }
    });

    // New tab button
    const newBtn = document.createElement('button');
    newBtn.className = 'new-tab-btn';
    newBtn.title = 'New tab';
    newBtn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`;
    newBtn.onclick = () => this.newTab();
    bar.appendChild(newBtn);
  },

  switchTab(id) {
    this.activeTabId = id;
    this.selected.clear();
    this.renderTabs();
    this.renderList();
    this.updateSelUI();
  },

  newTab() {
    this.tabCounter++;
    const id = `tab-${this.tabCounter}`;
    const color = TAB_COLORS[(this.tabs.length) % TAB_COLORS.length];
    this.tabs.push({ id, label: `Tab ${this.tabCounter}`, color, indices: new Set() });
    this.switchTab(id);
    // Auto-start rename on new tab
    this.startTabRename(id);
  },

  closeTab(id, e) {
    e.stopPropagation();
    const idx = this.tabs.findIndex(t => t.id === id);
    if (idx === -1) return;
    // Return members to "All"
    this.tabs.splice(idx, 1);
    if (this.activeTabId === id) {
      this.activeTabId = 'all';
    }
    this.renderTabs();
    this.renderList();
  },

  startTabRename(id) {
    this.renamingTabId = id;
    this.renderTabs();
  },
  handleTabRenameKey(e, id) {
    if (e.key === 'Enter') { e.preventDefault(); this.commitTabRename(id, e.target.value.trim()); }
    else if (e.key === 'Escape') { this.renamingTabId = null; this.renderTabs(); }
  },
  commitTabRename(id, name) {
    this.renamingTabId = null;
    const tab = this.tabs.find(t => t.id === id);
    if (tab && name) tab.label = name;
    this.renderTabs();
  },

  /** Assign an instance to a tab */
  moveToTab(instIndex, tabId) {
    // Remove from all other non-all tabs
    this.tabs.forEach(tab => {
      if (tab.id !== 'all' && tab.indices) tab.indices.delete(instIndex);
    });
    if (tabId !== 'all') {
      const tab = this.tabs.find(t => t.id === tabId);
      if (tab && tab.indices) tab.indices.add(instIndex);
    }
    this.renderTabs();
    this.renderList();
    const tabName = tabId === 'all' ? 'All Instances' : (this.tabs.find(t=>t.id===tabId)?.label || tabId);
    Toast.show('success', 'Moved', `Emulator #${instIndex} → "${tabName}"`);
  },

  getTabForInstance(instIndex) {
    for (const tab of this.tabs) {
      if (tab.id !== 'all' && tab.indices && tab.indices.has(instIndex)) return tab.id;
    }
    return 'all';
  },

  // ── FILTER / SEARCH ────────────────────────────
  setSearch(q) { this.search = q.toLowerCase().trim(); this.renderList(); },
  setFilter(f) {
    this.filter = f;
    ['all','running','stopped'].forEach(id => {
      const el = document.getElementById(`pill-${id}`);
      if (el) el.classList.toggle('active', id === f);
    });
    this.renderList();
  },

  getActiveTabInstances() {
    const activeTab = this.tabs.find(t => t.id === this.activeTabId);
    if (!activeTab || activeTab.indices === null) return this.instances;
    return this.instances.filter(i => activeTab.indices.has(i.index));
  },

  getFiltered() {
    return this.getActiveTabInstances().filter(inst => {
      if (this.search) {
        const hay = `${inst.name} ${inst.index} ${this.adbSerial(inst.index)}`.toLowerCase();
        if (!hay.includes(this.search)) return false;
      }
      if (this.filter === 'running' && !inst.running) return false;
      if (this.filter === 'stopped' && inst.running) return false;
      return true;
    });
  },

  // ── SELECTION ──────────────────────────────────
  toggleSel(index, checked) {
    if (checked) this.selected.add(index); else this.selected.delete(index);
    this.updateSelUI();
  },
  toggleSelectAll(checked) {
    this.getFiltered().forEach(inst => {
      if (checked) this.selected.add(inst.index); else this.selected.delete(inst.index);
      const cb = document.getElementById(`cb-${inst.index}`);
      if (cb) cb.checked = checked;
    });
    this.updateSelUI();
  },
  updateSelUI() {
    const count = this.selected.size;
    const filt  = this.getFiltered();
    document.getElementById('btn-start-sel').disabled = count === 0;
    document.getElementById('btn-stop-sel').disabled  = count === 0;
    document.getElementById('sel-count-start').textContent = count;
    document.getElementById('sel-count-stop').textContent  = count;
    const hint  = document.getElementById('sel-hint');
    const label = document.getElementById('sel-label');
    if (hint)  hint.style.display = count > 0 ? 'inline' : 'none';
    if (label) label.textContent  = count;
    const allCb = document.getElementById('cb-select-all');
    if (allCb) {
      allCb.checked = filt.length > 0 && filt.every(i => this.selected.has(i.index));
      allCb.indeterminate = count > 0 && !allCb.checked;
    }
  },

  // ── RENDER ────────────────────────────────────
  renderAll() { this.renderStats(); this.renderList(); },
  renderStats() {
    const total   = this.instances.length;
    const running = this.instances.filter(i => i.running).length;
    document.getElementById('stat-total').textContent   = total;
    document.getElementById('stat-running').textContent = running;
    document.getElementById('stat-stopped').textContent = total - running;
  },

  renderList() {
    const list     = document.getElementById('emu-list');
    const filtered = this.getFiltered();

    if (filtered.length === 0) {
      list.innerHTML = `
        <div class="empty-state">
          <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity:.3;">
            <rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/>
          </svg>
          <p style="font-size:13px;">No instances here.</p>
          <p style="font-size:11px;color:var(--muted-2);">Move instances to this tab via the ··· menu.</p>
        </div>`;
      return;
    }

    list.innerHTML = filtered.map((inst, i) => this.renderCard(inst, i)).join('');
    this.updateSelUI();
  },

  renderCard(inst, animIdx) {
    const sel    = this.selected.has(inst.index);
    const serial = this.adbSerial(inst.index);
    const isRen  = this.renamingIndex === inst.index;
    const pidTxt = inst.running && inst.pid ? `PID ${inst.pid}` : `PID —`;

    const statusBadge = inst.running
      ? `<span class="status-badge badge-running"><span class="pulse-dot"></span>RUNNING</span>`
      : `<span class="status-badge badge-stopped">STOPPED</span>`;

    const nameCell = isRen
      ? `<input type="text" id="rename-${inst.index}" class="rename-input"
               value="${this.escHtml(inst.name)}"
               onkeydown="App.handleRenameKey(event,${inst.index})"
               onblur="App.cancelRename(${inst.index})"
               onclick="event.stopPropagation()" />`
      : `<span ondblclick="App.startRename(${inst.index})" title="Double-click to rename"
             style="cursor:text;">${this.escHtml(inst.name)}</span>`;

    const actionBtns = inst.running
      ? `<button class="btn btn-ghost btn-icon" title="Stop #${inst.index}"
                onclick="App.stopInstance(${inst.index})" id="btn-action-${inst.index}">
           <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
         </button>
         <button class="btn btn-ghost btn-icon" title="Restart #${inst.index}"
                onclick="App.restartInstance(${inst.index})" id="btn-restart-${inst.index}">
           <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
             <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/>
           </svg>
         </button>`
      : `<button class="btn btn-ghost btn-icon" title="Start #${inst.index}"
                onclick="App.startInstance(${inst.index})" id="btn-action-${inst.index}">
           <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
         </button>`;

    return `
    <div class="emu-card ${inst.running?'running-card':''} ${sel?'selected':''}"
         id="card-${inst.index}" style="animation-delay:${animIdx*30}ms;">
      <input type="checkbox" id="cb-${inst.index}" ${sel?'checked':''}
             onchange="App.toggleSel(${inst.index},this.checked)" onclick="event.stopPropagation()" />
      <div class="idx-badge">#${inst.index}</div>
      <div class="emu-info">
        <div class="emu-name">${nameCell}</div>
        <div class="emu-meta">
          <span>${pidTxt}</span>
          <span class="sep">|</span>
          <span>${this.escHtml(inst.resolution)}</span>
          <span class="sep">|</span>
          <span>DPI ${inst.dpi}</span>
          <span class="sep">|</span>
          <span class="serial-text" id="serial-${inst.index}">${serial}</span>
          <button class="copy-btn" onclick="App.copySerial(${inst.index})" title="Copy ADB serial">
            <svg id="copy-icon-${inst.index}" viewBox="0 0 24 24" width="11" height="11" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
            </svg>
          </button>
        </div>
      </div>
      <div class="card-actions">
        ${statusBadge}
        <div class="hover-actions">
          ${actionBtns}
          <!-- ··· menu button -->
          <button class="btn btn-ghost btn-icon" title="More actions"
                  onclick="App.showCardMenu(event,${inst.index})" id="btn-more-${inst.index}"
                  style="font-size:14px; letter-spacing:1px; font-weight:700; color:var(--muted);">
            ···
          </button>
        </div>
      </div>
    </div>`;
  },

  // ── CARD ··· DROPDOWN MENU ─────────────────────
  showCardMenu(e, instIndex) {
    e.stopPropagation();
    this.closeActiveMenu();

    const inst   = this.instances.find(i => i.index === instIndex);
    const currentTabId = this.getTabForInstance(instIndex);
    const btnRect = e.currentTarget.getBoundingClientRect();

    const menu = document.createElement('div');
    menu.className = 'dropdown-menu';

    // ── Static items
    const items = [
      {
        icon: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`,
        label: 'Rename',
        action: () => this.startRename(instIndex),
      },
      {
        icon: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>`,
        label: 'Copy ADB Serial',
        action: () => this.copySerial(instIndex),
      },
    ];

    items.forEach(item => {
      const btn = document.createElement('button');
      btn.className = 'dd-item';
      btn.innerHTML = `<span class="dd-icon">${item.icon}</span><span>${item.label}</span>`;
      btn.onclick = () => { item.action(); this.closeActiveMenu(); };
      menu.appendChild(btn);
    });

    // ── "Move to Tab" section
    const sep = document.createElement('div'); sep.className = 'dd-sep'; menu.appendChild(sep);
    const subLabel = document.createElement('div'); subLabel.className = 'dd-sub-label'; subLabel.textContent = 'Move to Tab'; menu.appendChild(subLabel);

    this.tabs.forEach(tab => {
      const isCurrent = tab.id === currentTabId;
      const btn = document.createElement('button');
      btn.className = `dd-item tab-option${isCurrent ? ' disabled' : ''}`;
      btn.innerHTML = `
        <span class="tab-dot" style="background:${tab.color};"></span>
        <span style="flex:1;">${this.escHtml(tab.label)}</span>
        ${isCurrent ? `<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>` : ''}
      `;
      if (!isCurrent) btn.onclick = () => { this.moveToTab(instIndex, tab.id); this.closeActiveMenu(); };
      menu.appendChild(btn);
    });

    // Position below the ··· button
    menu.style.left = `${Math.min(btnRect.right - 180, window.innerWidth - 200)}px`;
    menu.style.top  = `${Math.min(btnRect.bottom + 4, window.innerHeight - 300)}px`;

    document.body.appendChild(menu);
    this.activeMenu = menu;
  },

  closeActiveMenu() {
    if (this.activeMenu) { this.activeMenu.remove(); this.activeMenu = null; }
  },

  // ── INSTANCE ACTIONS ──────────────────────────
  adbSerial(index) { return `emulator-${5554 + index * 2}`; },

  async startInstance(index) {
    this.setCardSpinner(index);
    await this.delay(800);
    const inst = this.instances.find(i => i.index === index);
    if (inst) { inst.running = true; inst.pid = Math.floor(Math.random()*5000+3000); }
    this.renderAll(); this.renderTabs();
    Toast.show('success', 'Launched', `Emulator #${index} is now running.`);
  },
  async stopInstance(index) {
    this.setCardSpinner(index);
    await this.delay(700);
    const inst = this.instances.find(i => i.index === index);
    if (inst) { inst.running = false; inst.pid = null; }
    this.renderAll(); this.renderTabs();
    Toast.show('info', 'Stopped', `Emulator #${index} has been stopped.`);
  },
  async restartInstance(index) {
    this.setCardSpinner(index);
    Toast.show('info','Restarting', `Stopping emulator #${index}…`);
    await this.delay(800);
    const inst = this.instances.find(i => i.index === index);
    if (inst) { inst.running = false; inst.pid = null; }
    this.renderAll();
    await this.delay(1200);
    if (inst) { inst.running = true; inst.pid = Math.floor(Math.random()*5000+3000); }
    this.renderAll(); this.renderTabs();
    Toast.show('success','Restarted',`Emulator #${index} is back online.`);
  },
  async startAll() {
    const stopped = this.instances.filter(i => !i.running);
    if (!stopped.length) { Toast.show('info','Start All','No stopped instances.'); return; }
    Toast.show('info','Start All',`Starting ${stopped.length} instances…`);
    await this.delay(900);
    stopped.forEach(inst => { inst.running = true; inst.pid = Math.floor(Math.random()*5000+3000); });
    this.renderAll(); this.renderTabs();
    Toast.show('success','Done',`All ${stopped.length} instances started.`);
  },
  async stopAll() {
    const running = this.instances.filter(i => i.running);
    if (!running.length) { Toast.show('info','Stop All','No running instances.'); return; }
    if (!confirm(`Stop all ${running.length} running instance(s)?`)) return;
    Toast.show('info','Stop All',`Stopping ${running.length} instances…`);
    await this.delay(800);
    running.forEach(inst => { inst.running = false; inst.pid = null; });
    this.renderAll(); this.renderTabs();
    Toast.show('success','Done',`${running.length} instances stopped.`);
  },
  async startSelected() {
    const idxs = Array.from(this.selected);
    if (!idxs.length) return;
    Toast.show('info','Batch Start',`Starting ${idxs.length} emulator(s)…`);
    this.selected.clear(); this.updateSelUI();
    await this.delay(900);
    idxs.forEach(idx => {
      const inst = this.instances.find(i => i.index === idx);
      if (inst && !inst.running) { inst.running = true; inst.pid = Math.floor(Math.random()*5000+3000); }
    });
    this.renderAll(); this.renderTabs();
    Toast.show('success','Done',`${idxs.length} emulator(s) started.`);
  },
  async stopSelected() {
    const idxs = Array.from(this.selected);
    if (!idxs.length) return;
    if (!confirm(`Stop ${idxs.length} selected emulator(s)?`)) return;
    Toast.show('info','Batch Stop',`Stopping ${idxs.length} emulator(s)…`);
    this.selected.clear(); this.updateSelUI();
    await this.delay(700);
    idxs.forEach(idx => {
      const inst = this.instances.find(i => i.index === idx);
      if (inst && inst.running) { inst.running = false; inst.pid = null; }
    });
    this.renderAll(); this.renderTabs();
    Toast.show('success','Done',`${idxs.length} emulator(s) stopped.`);
  },
  setCardSpinner(index) {
    const btn = document.getElementById(`btn-action-${index}`);
    if (btn) { btn.innerHTML = '<span class="spinner"></span>'; btn.disabled = true; }
  },

  // ── COPY SERIAL ───────────────────────────────
  async copySerial(index) {
    const serial = this.adbSerial(index);
    try { await navigator.clipboard.writeText(serial); } catch {}
    const icon = document.getElementById(`copy-icon-${index}`);
    if (icon) {
      icon.outerHTML = `<svg id="copy-icon-${index}" viewBox="0 0 24 24" width="11" height="11" fill="none" stroke="#22c55e" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>`;
      setTimeout(() => {
        const ic = document.getElementById(`copy-icon-${index}`);
        if (ic) ic.outerHTML = `<svg id="copy-icon-${index}" viewBox="0 0 24 24" width="11" height="11" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>`;
      }, 1500);
    }
    Toast.show('success','Copied',`"${serial}" copied.`);
  },

  // ── RENAME INSTANCE ───────────────────────────
  startRename(index) {
    this.renamingIndex = index;
    this.renderList();
    requestAnimationFrame(() => {
      const inp = document.getElementById(`rename-${index}`);
      if (inp) { inp.focus(); inp.select(); }
    });
  },
  handleRenameKey(e, index) {
    if (e.key === 'Enter') { e.preventDefault(); this.commitRename(index, e.target.value.trim()); }
    else if (e.key === 'Escape') this.cancelRename(index);
  },
  cancelRename(index) { if (this.renamingIndex === index) { this.renamingIndex = null; this.renderList(); } },
  commitRename(index, name) {
    this.renamingIndex = null;
    if (!name) { this.renderList(); return; }
    const inst = this.instances.find(i => i.index === index);
    if (inst) inst.name = name;
    this.renderList(); this.renderTabs();
    Toast.show('success','Renamed',`Instance #${index} → "${name}"`);
  },

  // ── UTILS ─────────────────────────────────────
  delay(ms) { return new Promise(r => setTimeout(r, ms)); },
  escHtml(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  },
};

// ── TOAST ─────────────────────────────────────────
const Toast = {
  show(type, title, msg) {
    const el = document.createElement('div');
    el.className = `toast ${type}`;
    el.innerHTML = `<div class="toast-dot"></div><span><strong>${title}</strong> — ${msg}</span>`;
    document.getElementById('toast-container').appendChild(el);
    setTimeout(() => { el.classList.add('toast-fade'); setTimeout(() => el.remove(), 300); }, 2800);
  }
};

document.addEventListener('click', () => App.closeActiveMenu());
App.init();
</script>
</body>
</html>
